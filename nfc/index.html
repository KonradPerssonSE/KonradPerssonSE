<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFC Debugger Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (JetBrains Mono for code) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- PWA Settings -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Animation for Scan Pulse */
        @keyframes radar {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .scanning-active { animation: radar 2s infinite; }
        
        /* Tab Transitions */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 p-4 shrink-0 z-20">
        <div class="flex justify-between items-center max-w-3xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">
                    <i class="fa-solid fa-bug"></i>
                </div>
                <div>
                    <h1 class="font-bold text-white text-lg leading-tight">NFC Debugger</h1>
                    <p class="text-[10px] text-slate-400 font-mono">V2.0 // RAW DATA MODE</p>
                </div>
            </div>
            <div id="status-indicator" class="text-xs font-mono px-2 py-1 rounded bg-slate-800 text-slate-400">
                IDLE
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-slate-900 border-b border-slate-800 shrink-0">
        <div class="flex max-w-3xl mx-auto">
            <button onclick="switchTab('scan')" id="tab-scan" class="flex-1 py-3 text-sm font-semibold border-b-2 border-blue-500 text-blue-400 transition-colors">
                <i class="fa-solid fa-satellite-dish mr-2"></i>Scanner
            </button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-3 text-sm font-semibold border-b-2 border-transparent text-slate-500 hover:text-slate-300 transition-colors">
                <i class="fa-solid fa-clock-rotate-left mr-2"></i>History
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative bg-slate-950">
        
        <!-- SCAN TAB -->
        <div id="view-scan" class="tab-content active h-full">
            <div class="max-w-3xl mx-auto p-4 min-h-full flex flex-col">
                
                <!-- Action Area -->
                <div class="mb-6 bg-slate-900 rounded-xl p-6 border border-slate-800 shadow-xl text-center">
                    <button id="btn-scan" class="w-24 h-24 rounded-full bg-slate-800 border-4 border-slate-700 text-slate-400 text-3xl flex items-center justify-center mx-auto mb-4 transition-all active:scale-95 shadow-lg">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                    <h2 id="scan-status-text" class="text-xl font-bold text-white mb-1">Tap to Start</h2>
                    <p class="text-xs text-slate-500">Enable NFC in Android Settings</p>
                </div>

                <!-- Latest Result Container -->
                <div id="latest-result" class="hidden flex-1">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Latest Capture</h3>
                        <span class="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded font-mono">LIVE</span>
                    </div>
                    <div id="latest-result-content"></div>
                </div>

                <!-- Empty State for Scan -->
                <div id="scan-empty" class="flex-1 flex flex-col items-center justify-center text-slate-700 opacity-50">
                    <i class="fa-brands fa-usb text-6xl mb-4"></i>
                    <p class="font-mono text-sm">Waiting for tag data stream...</p>
                </div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="view-history" class="tab-content h-full">
            <div class="max-w-3xl mx-auto p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Saved Logs</h3>
                    <button onclick="clearAllHistory()" class="text-xs text-red-400 hover:text-red-300 border border-red-900 bg-red-900/20 px-3 py-1 rounded transition-colors">
                        <i class="fa-solid fa-trash mr-1"></i> Clear All
                    </button>
                </div>
                <div id="history-list" class="space-y-3 pb-20">
                    <!-- History Items Injected Here -->
                </div>
            </div>
        </div>

    </main>

    <!-- Detail Modal (Overlay) -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-950 z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
        <!-- Modal Header -->
        <div class="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center shrink-0">
            <h2 class="font-bold text-white">Scan Details</h2>
            <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-800 text-slate-300 hover:bg-slate-700">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div id="modal-content" class="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto w-full">
            <!-- Details Injected Here -->
        </div>

        <!-- Modal Footer -->
        <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0 flex gap-3">
             <button onclick="copyCurrentJSON()" class="flex-1 bg-slate-800 text-slate-300 py-3 rounded-lg font-mono text-xs font-bold hover:bg-slate-700">
                <i class="fa-solid fa-copy mr-2"></i>COPY JSON
            </button>
            <button onclick="deleteCurrentLog()" class="flex-1 bg-red-900/30 text-red-400 border border-red-900/50 py-3 rounded-lg font-mono text-xs font-bold hover:bg-red-900/50">
                DELETE LOG
            </button>
        </div>
    </div>

    <script>
        // --- DATA UTILITIES (The Brains) ---

        // Convert DataView to Hex String (00 AF 12 ...)
        function bufferToHex(dataView) {
            if (!dataView) return "NULL";
            const arr = new Uint8Array(dataView.buffer);
            return Array.from(arr)
                .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                .join(' ');
        }

        // Convert DataView to ASCII string (sanitized)
        function bufferToAscii(dataView) {
            if (!dataView) return "";
            const arr = new Uint8Array(dataView.buffer);
            let str = "";
            for (let i = 0; i < arr.length; i++) {
                const char = arr[i];
                // Only printable ASCII
                str += (char > 31 && char < 127) ? String.fromCharCode(char) : '.';
            }
            return str;
        }

        // Convert DataView to Base64 (for storage)
        function bufferToBase64(dataView) {
            if(!dataView) return "";
            let binary = '';
            const bytes = new Uint8Array(dataView.buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // Base64 to ArrayBuffer (for retrieval)
        function base64ToBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return new DataView(bytes.buffer);
        }

        // --- APP STATE ---

        let ndefReader;
        let isScanning = false;
        let abortController = new AbortController();
        let historyData = JSON.parse(localStorage.getItem('nfc_debug_history') || '[]');
        let currentViewingId = null;

        // --- CORE FUNCTIONS ---

        async function toggleScan() {
            const btn = document.getElementById('btn-scan');
            const statusText = document.getElementById('scan-status-text');
            const statusInd = document.getElementById('status-indicator');

            if (isScanning) {
                // Stop
                abortController.abort();
                isScanning = false;
                btn.classList.remove('scanning-active', 'bg-green-600', 'border-green-400', 'text-white');
                btn.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-400');
                btn.innerHTML = '<i class="fa-solid fa-power-off"></i>';
                statusText.innerText = "Scan Stopped";
                statusInd.innerText = "IDLE";
                statusInd.className = "text-xs font-mono px-2 py-1 rounded bg-slate-800 text-slate-400";
            } else {
                // Start
                if (!('NDEFReader' in window)) {
                    alert("Web NFC not supported on this device.");
                    return;
                }
                
                try {
                    abortController = new AbortController();
                    ndefReader = new NDEFReader();
                    await ndefReader.scan({ signal: abortController.signal });
                    
                    isScanning = true;
                    btn.classList.add('scanning-active', 'bg-green-600', 'border-green-400', 'text-white');
                    btn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-400');
                    btn.innerHTML = '<i class="fa-solid fa-wifi"></i>';
                    statusText.innerText = "Scanning...";
                    statusInd.innerText = "LISTENING";
                    statusInd.className = "text-xs font-mono px-2 py-1 rounded bg-green-900 text-green-400 animate-pulse";
                    
                    document.getElementById('scan-empty').classList.remove('hidden');
                    document.getElementById('latest-result').classList.add('hidden');

                    ndefReader.onreading = (event) => {
                        handleReading(event);
                    };

                    ndefReader.onreadingerror = () => {
                        statusText.innerText = "Read Error - Keep Tag Steady";
                        navigator.vibrate(300);
                    };

                } catch (error) {
                    console.error(error);
                    statusText.innerText = "Error: " + error.message;
                    isScanning = false;
                }
            }
        }

        function handleReading({ message, serialNumber }) {
            navigator.vibrate([50, 50]); // Success haptic
            
            // 1. Structure Data
            const scanEntry = {
                id: crypto.randomUUID(),
                timestamp: new Date().toISOString(),
                serialNumber: serialNumber || "No UID",
                records: message.records.map(r => ({
                    recordType: r.recordType,
                    mediaType: r.mediaType,
                    id: r.id,
                    encoding: r.encoding,
                    lang: r.lang,
                    // Save payload as Base64 for storage
                    dataBase64: bufferToBase64(r.data),
                    // Also store size
                    byteLength: r.data ? r.data.byteLength : 0
                }))
            };

            // 2. Save
            historyData.unshift(scanEntry); // Add to top
            localStorage.setItem('nfc_debug_history', JSON.stringify(historyData));
            
            // 3. Render "Live" View
            renderLiveResult(scanEntry);
            
            // 4. Update History List in background
            renderHistoryList();
        }

        // --- RENDERING ---

        function renderLiveResult(entry) {
            document.getElementById('scan-empty').classList.add('hidden');
            const container = document.getElementById('latest-result');
            const content = document.getElementById('latest-result-content');
            
            container.classList.remove('hidden');
            // Re-use the card renderer
            content.innerHTML = generateDetailHTML(entry, false);
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            
            if (historyData.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-600 py-10 font-mono text-sm">No scans saved.</div>`;
                return;
            }

            historyData.forEach(entry => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = date.toLocaleDateString();
                
                const item = document.createElement('div');
                item.className = "bg-slate-900 border border-slate-800 rounded-lg p-4 hover:bg-slate-800 cursor-pointer transition-colors group";
                item.onclick = () => openModal(entry.id);
                
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-green-400 font-mono font-bold text-sm">${entry.serialNumber}</span>
                                <span class="text-[10px] text-slate-500 bg-slate-950 px-1.5 rounded">${entry.records.length} Records</span>
                            </div>
                            <div class="text-xs text-slate-500 font-mono">${dateStr} ${timeStr}</div>
                        </div>
                        <div class="text-slate-600 group-hover:text-blue-400 transition-colors">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function generateDetailHTML(entry) {
            const date = new Date(entry.timestamp).toLocaleString();
            
            let html = `
                <!-- Meta Card -->
                <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] uppercase text-slate-500 font-bold mb-1">UID (Serial)</p>
                            <p class="font-mono text-green-400 text-lg select-all">${entry.serialNumber}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] uppercase text-slate-500 font-bold mb-1">Captured</p>
                            <p class="font-mono text-slate-300 text-xs">${date}</p>
                        </div>
                    </div>
                </div>
            `;

            // Records Loop
            if (entry.records.length === 0) {
                html += `<div class="p-4 border-2 border-dashed border-slate-800 rounded-xl text-center text-slate-500">No NDEF Records Found</div>`;
            } else {
                entry.records.forEach((rec, idx) => {
                    // Restore DataView for processing
                    const dataView = base64ToBuffer(rec.dataBase64);
                    const hex = bufferToHex(dataView);
                    const ascii = bufferToAscii(dataView);
                    
                    // Decode text payload if recordType is text
                    let decodedText = null;
                    if(rec.recordType === 'text') {
                        try { const decoder = new TextDecoder(); decodedText = decoder.decode(dataView); } catch(e){}
                    }
                    if(rec.recordType === 'url') {
                        try { const decoder = new TextDecoder(); decodedText = decoder.decode(dataView); } catch(e){}
                    }

                    html += `
                        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden mb-4 shadow-sm">
                            <!-- Record Header -->
                            <div class="bg-slate-800/50 p-3 border-b border-slate-800 flex justify-between items-center">
                                <span class="font-bold text-xs text-blue-400 uppercase tracking-wider">Record #${idx+1} : ${rec.recordType}</span>
                                <span class="text-[10px] text-slate-500 font-mono">${rec.byteLength} Bytes</span>
                            </div>
                            
                            <!-- Properties -->
                            <div class="p-3 grid grid-cols-2 gap-y-2 gap-x-4 text-xs font-mono text-slate-400 border-b border-slate-800/50">
                                ${rec.mediaType ? `<div><span class="text-slate-600">MIME:</span> <span class="text-slate-300">${rec.mediaType}</span></div>` : ''}
                                ${rec.encoding ? `<div><span class="text-slate-600">Enc:</span> <span class="text-slate-300">${rec.encoding}</span></div>` : ''}
                                ${rec.lang ? `<div><span class="text-slate-600">Lang:</span> <span class="text-slate-300">${rec.lang}</span></div>` : ''}
                                ${rec.id ? `<div><span class="text-slate-600">ID:</span> <span class="text-slate-300">${rec.id}</span></div>` : ''}
                            </div>

                            ${decodedText ? `
                            <div class="p-3 bg-blue-900/10 border-b border-blue-900/20">
                                <p class="text-[10px] uppercase text-blue-500 font-bold mb-1">Decoded Payload</p>
                                <p class="text-sm text-blue-100 break-words font-medium">${decodedText}</p>
                            </div>
                            ` : ''}

                            <!-- Hex Dump -->
                            <div class="p-3">
                                <p class="text-[10px] uppercase text-slate-600 font-bold mb-1">Hex Dump</p>
                                <div class="font-mono text-xs text-slate-400 bg-black/30 p-2 rounded break-all tracking-wider leading-relaxed select-all border border-slate-800">
                                    ${hex}
                                </div>
                            </div>
                            
                            <!-- ASCII Dump -->
                            <div class="p-3 pt-0">
                                <p class="text-[10px] uppercase text-slate-600 font-bold mb-1">ASCII View</p>
                                <div class="font-mono text-xs text-slate-500 bg-black/30 p-2 rounded break-all tracking-widest select-all border border-slate-800">
                                    ${ascii}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- MODAL LOGIC ---

        function openModal(id) {
            currentViewingId = id;
            const entry = historyData.find(e => e.id === id);
            if (!entry) return;

            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = generateDetailHTML(entry);
            modal.classList.remove('translate-y-full');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('translate-y-full');
            currentViewingId = null;
        }

        function deleteCurrentLog() {
            if(!confirm("Delete this log permanently?")) return;
            historyData = historyData.filter(h => h.id !== currentViewingId);
            localStorage.setItem('nfc_debug_history', JSON.stringify(historyData));
            closeModal();
            renderHistoryList();
        }

        function copyCurrentJSON() {
            const entry = historyData.find(e => e.id === currentViewingId);
            if(!entry) return;
            // Clean up for export (optional, but good)
            const exportData = JSON.stringify(entry, null, 2);
            navigator.clipboard.writeText(exportData).then(() => {
                alert("Raw JSON copied to clipboard");
            });
        }

        // --- HISTORY MANAGEMENT ---

        function clearAllHistory() {
            if(!confirm("Clear ALL history? This cannot be undone.")) return;
            historyData = [];
            localStorage.removeItem('nfc_debug_history');
            renderHistoryList();
        }

        // --- TAB SWITCHING ---

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active');
            
            // UI Updates
            const scanTabBtn = document.getElementById('tab-scan');
            const histTabBtn = document.getElementById('tab-history');

            if(tabName === 'scan') {
                scanTabBtn.classList.replace('border-transparent', 'border-blue-500');
                scanTabBtn.classList.replace('text-slate-500', 'text-blue-400');
                histTabBtn.classList.replace('border-blue-500', 'border-transparent');
                histTabBtn.classList.replace('text-blue-400', 'text-slate-500');
            } else {
                renderHistoryList();
                histTabBtn.classList.replace('border-transparent', 'border-blue-500');
                histTabBtn.classList.replace('text-slate-500', 'text-blue-400');
                scanTabBtn.classList.replace('border-blue-500', 'border-transparent');
                scanTabBtn.classList.replace('text-blue-400', 'text-slate-500');
            }
        }

        // --- INITIALIZATION ---
        
        document.getElementById('btn-scan').addEventListener('click', toggleScan);

        // PWA Service Worker (Persistence)
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
            `;
            const swBlob = new Blob([swCode], {type: 'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(swBlob));
        }

        // Create Manifest
        const manifest = {
            "name": "NFC Debugger",
            "short_name": "NFC Debug",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#0f172a",
            "icons": [{"src": "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/bug.svg", "sizes": "192x192", "type": "image/svg+xml"}]
        };
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
        document.head.appendChild(link);

    </script>
</body>
</html>