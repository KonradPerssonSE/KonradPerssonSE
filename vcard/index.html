<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/6/63/Icon_Bird_512x512.png"/>

    <!-- Tesseract OCR CDN -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #00ff41; /* Terminal green */
            --text: #e0e0e0;
            --dim: #888;
            --border: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 {
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--primary);
            padding-bottom: 10px;
            margin-top: 0;
            color: var(--primary);
        }

        /* --- UI Elements --- */
        .btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 15px;
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
            cursor: pointer;
            margin-bottom: 15px;
            text-transform: uppercase;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn:active {
            background: var(--primary);
            color: black;
            transform: scale(0.98);
        }

        .btn.secondary {
            border-color: var(--dim);
            color: var(--dim);
            font-size: 0.9rem;
            padding: 10px;
        }

        input, textarea {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            font-family: inherit;
            margin-bottom: 10px;
            font-size: 16px; /* FÃ¶rhindrar zoom pÃ¥ iOS/Android */
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        label {
            font-size: 0.75rem;
            color: var(--dim);
            margin-bottom: 4px;
            display: block;
            text-transform: uppercase;
        }

        /* --- Sections --- */
        .section {
            background: var(--surface);
            padding: 15px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active { display: block; }

        /* --- Loader --- */
        #loader {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
        }
        .scan-line {
            height: 2px;
            background: var(--primary);
            width: 100%;
            animation: scan 1.5s infinite alternate;
        }

        /* --- History List --- */
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .history-item:last-child { border-bottom: none; }
        .history-name { font-weight: bold; }
        .history-meta { font-size: 0.8rem; color: var(--dim); }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scan { from { width: 0%; opacity: 0.2; } to { width: 100%; opacity: 1; } }
        
        .flash { animation: flashAnim 0.5s; }
        @keyframes flashAnim { 0% { background-color: var(--primary); } 100% { background-color: transparent; } }

        /* --- Image Preview --- */
        #image-preview {
            max-width: 100%;
            border: 1px dashed var(--dim);
            margin-bottom: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <header>
        <h1>Scan > vCard</h1>
    </header>

    <!-- MAIN MENU -->
    <div id="view-menu" class="section active">
        <label for="camera-input" class="btn">
            ðŸ“· Fota Visitkort
            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
        </label>
        
        <div id="history-container">
            <label>Tidigare skanningar</label>
            <div id="history-list"></div>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="scan-line"></div>
        <p id="status-text">Initierar OCR-motor...</p>
    </div>

    <!-- EDIT & RESULT VIEW -->
    <div id="view-result" class="section">
        <img id="image-preview" alt="Scanned Card">
        
        <label>Extraherad Text (Redigera om fel)</label>
        <textarea id="raw-text" rows="4" placeholder="RÃ¥data frÃ¥n bild..."></textarea>
        
        <div style="margin-top: 20px; border-top: 1px dashed var(--dim); padding-top: 10px;">
            <label>Namn (FN)</label>
            <input type="text" id="inp-name" placeholder="FÃ¶rnamn Efternamn">
            
            <label>Telefon (TEL)</label>
            <input type="tel" id="inp-phone" placeholder="+46...">
            
            <label>Email (EMAIL)</label>
            <input type="email" id="inp-email" placeholder="namn@fÃ¶retag.se">
            
            <label>Organisation (ORG)</label>
            <input type="text" id="inp-org" placeholder="FÃ¶retag AB">
        </div>

        <button id="btn-save-vcard" class="btn">ðŸ’¾ Skapa & Spara Kontakt</button>
        <button id="btn-reset" class="btn secondary">â¬… Tillbaka</button>
    </div>

    <script>
        // ==========================================
        // STATE & DOM ELEMENTS
        // ==========================================
        const els = {
            input: document.getElementById('camera-input'),
            viewMenu: document.getElementById('view-menu'),
            viewResult: document.getElementById('view-result'),
            loader: document.getElementById('loader'),
            status: document.getElementById('status-text'),
            preview: document.getElementById('image-preview'),
            rawText: document.getElementById('raw-text'),
            inpName: document.getElementById('inp-name'),
            inpPhone: document.getElementById('inp-phone'),
            inpEmail: document.getElementById('inp-email'),
            inpOrg: document.getElementById('inp-org'),
            btnSave: document.getElementById('btn-save-vcard'),
            btnReset: document.getElementById('btn-reset'),
            historyList: document.getElementById('history-list')
        };

        // ==========================================
        // UTILS
        // ==========================================
        const vibrate = (ms = 50) => {
            if (navigator.vibrate) navigator.vibrate(ms);
        };

        const showView = (viewName) => {
            els.viewMenu.classList.remove('active');
            els.viewResult.classList.remove('active');
            els.loader.style.display = 'none';

            if (viewName === 'menu') els.viewMenu.classList.add('active');
            if (viewName === 'result') els.viewResult.classList.add('active');
            if (viewName === 'loader') els.loader.style.display = 'block';
        };

        // ==========================================
        // OCR LOGIC
        // ==========================================
        els.input.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            vibrate(100);
            showView('loader');
            
            // Visa bild
            els.preview.src = URL.createObjectURL(file);
            els.preview.style.display = 'block';

            els.status.innerText = "LÃ¤ser in bild...";

            try {
                const result = await Tesseract.recognize(
                    file,
                    'swe', // Svenska + Engelska (fallback)
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                els.status.innerText = `LÃ¤ser text: ${(m.progress * 100).toFixed(0)}%`;
                            }
                        }
                    }
                );
                
                vibrate([50, 50, 50]);
                processOCRResult(result.data.text);

            } catch (err) {
                alert("OCR Misslyckades: " + err);
                showView('menu');
            }
        });

        function processOCRResult(text) {
            // 1. Rensa texten lite
            const cleanText = text.replace(/\n\s*\n/g, '\n');
            els.rawText.value = cleanText;

            // 2. Enkel Heuristik / Regex fÃ¶r att gissa fÃ¤lt
            // Email regex
            const emailMatch = text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/);
            els.inpEmail.value = emailMatch ? emailMatch[0] : '';

            // Telefon regex (FÃ¶renklad, letar efter mÃ¶nster som liknar nummer)
            // Tar bort bokstÃ¤ver, letar efter 7+ siffror i grupp
            const phoneMatch = text.match(/(\+?(\d[\d-. ]+)?(\([\d-. ]+\))?[\d-. ]+\d)/); 
            // Varning: Phone regex Ã¤r svÃ¥rt pÃ¥ visitkort dÃ¥ det finns org nummer, fax, mob, vÃ¤xel etc.
            // Vi tar fÃ¶rsta bÃ¤sta trÃ¤ff som ser ut som ett nummer > 6 tecken
            els.inpPhone.value = phoneMatch && phoneMatch[0].length > 6 ? phoneMatch[0].trim() : '';

            // Namn Ã¤r svÃ¥rt. Vi gissar att fÃ¶rsta raden som INTE Ã¤r en email eller telefon Ã¤r namnet eller fÃ¶retaget.
            const lines = cleanText.split('\n').map(l => l.trim()).filter(l => l.length > 2);
            // Ta fÃ¶rsta raden som default namn om den inte innehÃ¥ller @
            if (lines.length > 0 && !lines[0].includes('@')) {
                els.inpName.value = lines[0];
            } else {
                els.inpName.value = '';
            }

            // Gissa org (Andra raden?)
            if (lines.length > 1 && !lines[1].includes('@')) {
                els.inpOrg.value = lines[1];
            }

            showView('result');
        }

        // ==========================================
        // VCARD & STORAGE LOGIC
        // ==========================================
        els.btnSave.addEventListener('click', () => {
            vibrate();

            const contact = {
                fn: els.inpName.value || 'OkÃ¤nd',
                tel: els.inpPhone.value || '',
                email: els.inpEmail.value || '',
                org: els.inpOrg.value || ''
            };

            // 1. Generera vCard Blob
            const vcardBody = [
                'BEGIN:VCARD',
                'VERSION:3.0',
                `FN:${contact.fn}`,
                `N:;${contact.fn};;;`,
                `ORG:${contact.org}`,
                `TEL;TYPE=CELL:${contact.tel}`,
                `EMAIL:${contact.email}`,
                'END:VCARD'
            ].join('\n');

            const blob = new Blob([vcardBody], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            // 2. Trigga nedladdning
            const link = document.createElement('a');
            link.href = url;
            link.download = `${contact.fn.replace(/ /g, '_')}.vcf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // 3. Spara till localstorage historik
            saveToHistory(contact);
        });

        els.btnReset.addEventListener('click', () => {
            vibrate();
            showView('menu');
            els.input.value = ''; // Reset input file
        });

        // ==========================================
        // LOCALSTORAGE HISTORY
        // ==========================================
        function saveToHistory(contact) {
            const history = JSON.parse(localStorage.getItem('ocr_vcard_history') || '[]');
            history.unshift(contact);
            // Spara max 10
            if (history.length > 10) history.pop();
            localStorage.setItem('ocr_vcard_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('ocr_vcard_history') || '[]');
            els.historyList.innerHTML = '';

            if (history.length === 0) {
                els.historyList.innerHTML = '<div style="color:var(--dim); font-size:0.8rem; padding:10px;">Ingen historik Ã¤n.</div>';
                return;
            }

            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-name">${item.fn}</div>
                    <div class="history-meta">${item.org || ''}</div>
                `;
                div.onclick = () => {
                    // Ladda tillbaka in i fÃ¤lten
                    vibrate();
                    els.inpName.value = item.fn;
                    els.inpPhone.value = item.tel;
                    els.inpEmail.value = item.email;
                    els.inpOrg.value = item.org;
                    els.rawText.value = "HÃ¤mtad frÃ¥n historik.";
                    els.preview.style.display = 'none';
                    showView('result');
                };
                els.historyList.appendChild(div);
            });
        }

        // Init
        renderHistory();

        // Workaround fÃ¶r att "copy" ska fungera manuellt
        els.rawText.addEventListener('click', function() {
            this.select();
        });

    </script>
</body>
</html>