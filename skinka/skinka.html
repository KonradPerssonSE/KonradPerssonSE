<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Julskinkaâ€¯â€“â€¯Simulering v1.1</title>
<style>
  :root {
    --bg: #f8f1e7;
    --panel: #fff0e6;
    --border: #b87c5a;
    --font: sans-serif;
  }
  body {
    margin: 0;
    padding: 1.5rem;
    font-family: var(--font);
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  h1 { margin: 0.2rem 0 1rem 0; }
  .controls, .info, .log { background: var(--panel); border: 2px solid var(--border); border-radius: 8px; padding: 1rem; }
  .controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
  label { font-size: 0.9rem; }
  input[type="number"] { width: 4.5rem; padding: 0.2rem 0.3rem; }
  button { padding: 0.4rem 0.9rem; font-size: 1rem; cursor: pointer; }
  canvas { border: 2px solid var(--border); border-radius: 10px; background: #fceee3; }
  .info { font-size: 1.1rem; }
  .log { width: 400px; height: 160px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; }
</style>
</head>
<body>

<h1>Julskinkaâ€¯â€“â€¯VÃ¤rmeledning (vâ€¯1.1)</h1>

<!--â€ŠKontrollerâ€Š-->
<div class="controls">
  <label>Vikt (kg): <input type="number" id="weight" value="2" min="0.5" step="0.1"></label>
  <label>Ugn (Â°C): <input type="number" id="ovenTemp" value="175" min="50" max="300"></label>
  <button id="startBtn">Starta ugnen</button>
</div>

<!--â€ŠSkinkaâ€Š-->
<canvas id="skinka" width="400" height="400"></canvas>

<!--â€ŠAktuell infoâ€Š-->
<div class="info" id="infoBox">Status: vÃ¤ntar pÃ¥ start</div>

<!--â€ŠLoggâ€Š-->
<div class="log" id="logBox"></div>

<script>
/* ---------- KONSTANTER ---------- */
const rho  = 1050;   // kg/mÂ³ densitet
const cp   = 2800;   // J/kgÂ·K
const k    = 0.45;   // W/mÂ·K
const alpha= k / (rho * cp); // termisk diffusivitet
const layers = 50;   // diskreta skikt

/* ---------- DOMâ€‘OBJEKT ---------- */
const canvas  = document.getElementById("skinka");
const ctx     = canvas.getContext("2d");
const infoBox = document.getElementById("infoBox");
const logBox  = document.getElementById("logBox");
const startBtn= document.getElementById("startBtn");
const weightI = document.getElementById("weight");
const ovenI   = document.getElementById("ovenTemp");

/* ---------- SIMâ€‘DATA (initialt tom) ---------- */
let T = [];                 // temperatur i varje lager
let r_phys = [];            // radier (m) fysiskt
let r_pix  = [];            // radier (px) fÃ¶r ritning
let dr_phys, pixelScale;
let ovenT, running = false;
let simTime = 0, lastReal = 0, nextLog = 0;

/* ---------- HJÃ„LPFUNKTIONER ---------- */
function log(line) {
  logBox.textContent += line + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}

function initialise() {
  /* 1. LÃ¤s in-data */
  const mass = parseFloat(weightI.value);          // kg
  ovenT = parseFloat(ovenI.value);                 // Â°C
  if (mass <= 0 || isNaN(mass)) { alert("Ogiltig vikt"); return; }

  /* 2. BerÃ¤kna radie (m) utifrÃ¥n volymen m/rho (sfÃ¤râ€‘approx.) */
  const volume = mass / rho;                       // mÂ³
  const R_phys = Math.cbrt( (3*volume)/(4*Math.PI) ); // m

  /* 3. Skala till canvasâ€‘pixlar â€“ max radie 180â€¯px */
  pixelScale = 180 / R_phys;
  r_pix  = Array.from({length: layers}, (_,i)=> (i*R_phys/layers)*pixelScale);
  r_phys = Array.from({length: layers}, (_,i)=>  i*R_phys/layers);
  dr_phys= R_phys / layers;

  /* 4. Starttemperaturer */
  T = Array(layers).fill(5);                       // 5â€¯Â°C i hela skinkan

  /* 5. NollstÃ¤ll tidsrÃ¤knare & logg */
  simTime = 0; nextLog = 0; lastReal = performance.now();
  logBox.textContent = "";
  log(`Vikt: ${mass.toFixed(2)}â€¯kg  |  Radie â‰ˆ ${(R_phys*100).toFixed(1)}â€¯cm`);
  log(`Ugn:  ${ovenT}â€¯Â°C`);
}

function update(dtSim) {
  /* Finita differenser i sfÃ¤risk 1D â€‘ samma metod som tidigare men med variabel dt */
  const newT = [...T];
  for (let i=1;i<layers-1;i++) {
    const r = r_phys[i];
    const d2T = (T[i+1] - 2*T[i] + T[i-1]) / (dr_phys*dr_phys);
    const dT  = (T[i+1] - T[i-1]) / (2*dr_phys);
    newT[i] += alpha * (d2T + (2/r)*dT) * dtSim;
  }
  /* centrum (symmetri) */
  newT[0] = newT[1];

  /* yta (konvektion mot ugn) */
  const h = 25;
  newT[layers-1] += (2*alpha*dtSim/dr_phys)*(
      (T[layers-2]-T[layers-1])/dr_phys + (h/k)*(ovenT - T[layers-1])
  );
  T = newT;
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx = canvas.width/2, cy=cx;
  for (let i=layers-1;i>=0;i--) {
    const t = Math.min(T[i],100);                  // klippa fÃ¤rg
    const red   = 200 + t*0.5;
    const green = 80  - t*0.3;
    const blue  = 80  - t*0.3;
    ctx.beginPath();
    ctx.arc(cx,cy,r_pix[i],0,Math.PI*2);
    ctx.fillStyle = `rgb(${red}, ${Math.max(green,0)}, ${Math.max(blue,0)})`;
    ctx.fill();
  }
}

function animate(now) {
  if (!running) return;
  /* 1. Tidshantering */
  const realDt = (now - lastReal)/1000;    // sekunder realtid
  lastReal     = now;
  const dtSim  = realDt * 60;              // 1â€¯s real = 1â€¯min (â‰ˆ5â€¯sâ†’5â€¯min)
  simTime     += dtSim;

  /* 2. Fysik */
  update(dtSim);

  /* 3. Logg var 5 simâ€‘min */
  if (simTime >= nextLog) {
    log(`t=${(simTime/60).toFixed(0)}â€¯min  |  Mitt=${T[0].toFixed(1)}â€¯Â°C`);
    nextLog += 300; // 5 min i sek
  }

  /* 4. Ritning + info */
  draw();
  infoBox.textContent = `Mittens temp: ${T[0].toFixed(1)}â€¯Â°C  |  Ugn: ${ovenT}â€¯Â°C  |  Simâ€‘tid: ${(simTime/60).toFixed(1)}â€¯min`;

  /* 5. Stoppa om skinkan Ã¤r klar (70â€¯Â°C) */
  if (T[0] >= 70) {
    running = false;
    infoBox.textContent += "  â€“  KLAR ðŸŽ‰";
    log("Skinkan har nÃ¥tt 70â€¯Â°C i mitten â€“ fÃ¤rdig!");
    startBtn.disabled = false;
    return;
  }
  /* 6. FortsÃ¤tt */
  requestAnimationFrame(animate);
}

/* ---------- EVENT ---------- */
startBtn.addEventListener("click", () => {
  initialise();
  running = true;
  startBtn.disabled = true;
  infoBox.textContent = "Ugn pÃ¥slagen â€“ simulering startar â€¦";
  requestAnimationFrame(animate);
});
</script>

</body>
</html>